<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <link rel="icon" th:href="@{/favicon.png}" />

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" />
    <link th:href="@{/jquery-datatables-editable/datatables.css}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css"/>
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.5.1/css/buttons.dataTables.min.css"/>
    <link rel="stylesheet" href="https://cdn.datatables.net/select/1.2.5/css/select.dataTables.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" th:href="@{/app.css}" />

    <title>Bus Tracking System | Buses Location</title>
</head>
<body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExample04" aria-controls="navbarsExample04" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarsExample04">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item" sec:authorize="hasAnyRole('ROLE_ADMIN')">
            <a class="nav-link" th:href="@{/students}">Student</a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" th:href="@{/map}">Map</a>
          </li>
          <li class="nav-item" sec:authorize="hasAnyRole('ROLE_ADMIN')">
            <a class="nav-link" th:href="@{/parents}">Parents</a>
          </li>
          <li class="nav-item" sec:authorize="hasAnyRole('ROLE_ADMIN')">
            <a class="nav-link" th:href="@{/users}">Users</a>
          </li>
        </ul>
        <div class="pull-right">
         <a class="nav-link" th:href="@{/logout}"><i class="fa fa-sign-out"></i></a>
        </div> 
      </div>
    </nav>
    <div class="search-bar container">
        <div class="row">
            <div class="col-sm">
                <form action="#" method="get">
                    <div class="input-field">
                        <input name="q" type="search" placeholder="Search for a bus..." required="required" autocomplete="off"/>
                        <i class="material-icons">search</i>
                    </div>
                </form>
            </div>
        </div>
    </div><br/>
    <div class="container">
        <div class="row">
            <h3>Current Location of Buses</h3><br/>
    <div id="map"></div>
        </div>
    </div>
    
<script src="https://www.gstatic.com/firebasejs/4.10.0/firebase.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.9.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.9.1/firebase-database.js"></script>
    <script>
 //Initialize Firebase
    var config = {
      apiKey: "AIzaSyBmwMUNx-Ez_153zEtVU9kSLI_Bw5sQs9U",
      authDomain: "bustrackingsystem-1aee0.firebaseapp.com",
      databaseURL: "https://bustrackingsystem-1aee0.firebaseio.com",
      projectId: "bustrackingsystem-1aee0",
      storageBucket: "bustrackingsystem-1aee0.appspot.com",
      messagingSenderId: "546115008344"
    };
 
    firebase.initializeApp(config);
    
    var latitude, longitude;
    
    var busLocation = firebase.database().ref('Location');
        busLocation.on('value', function(snapshot) {
      	  var location=snapshot.val();
      	  latitude = Number(location.split(",")[0].trim());
      	  longitude = Number(location.split(",")[1].trim());
      	  initMap(latitude, longitude);
    });
        
      function initMap(latitude, longitude) {
        var currentLocation = {lat: latitude, lng: longitude};
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 4,
          center: currentLocation
        });
        
        //zoom into the location of the bus
        map.setZoom(10);
        
        var marker = new google.maps.Marker({
          position: currentLocation,
          map: map,
          icon: 'icons/bus.ico'
        });
        
        marker.addListener('click', function() {
        	alert("latitude: " + latitude + ", longitude: " + longitude)
            //map.setZoom(8);
            //map.setCenter(marker.getPosition());
          });
      } 
    </script>
 <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDtZeGCdqb5KqAG5ROpf1d6oUdAVwzTpyc&callback=initMap">
   </script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" ></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" ></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" ></script>
<script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
</body>
</html>